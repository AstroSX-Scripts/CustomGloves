

if getgenv and getgenv().AstralDominatorLoaded then return end
getgenv().AstralDominatorLoaded = true

local Players        = game:GetService("Players")
local RunService     = game:GetService("RunService")
local TweenService   = game:GetService("TweenService")
local Workspace      = game:GetService("Workspace")
local Lighting       = game:GetService("Lighting")
local Camera         = Workspace.CurrentCamera

local player         = Players.LocalPlayer
local playerGui      = player:WaitForChild("PlayerGui", 10)

local customSpawnUsed = false
local wingGiven      = false
local outfitGiven    = false

local CUSTOM_POS = Vector3.new(-4.3309, -5.1445, -191.455)

-- VISUALIZER CONFIG
local VIS_RADIUS     = 9.5
local NUM_BARS       = 32
local MAX_BAR_HEIGHT = 4.0
local BAR_COLOR      = Color3.fromRGB(20, 80, 180)
local BAR_WIDTH      = 0.68
local visualizerBars = {}
local bloomEffect    = nil
local lastLoudness   = 0
local rotationAngle  = 0

-- GLOBAL SOUND REFERENCE
local sound = nil

-- DESPAIR ANIMATION PACK
local function setupDespairAnims(char)
    local humanoid = char:WaitForChild("Humanoid", 8)
    if not humanoid then return end

    local animator = humanoid:FindFirstChildOfClass("Animator") or Instance.new("Animator", humanoid)

    local idle = Instance.new("Animation")
    idle.AnimationId = "rbxassetid://13544664658"
    local idleTrack = humanoid:LoadAnimation(idle)
    idleTrack.Priority = Enum.AnimationPriority.Idle
    idleTrack:AdjustSpeed(0.1)

    local animate = char:FindFirstChild("Animate")
    if animate and animate:FindFirstChild("walk") then
        animate.walk.WalkAnim.AnimationId = "rbxassetid://101931532422335"
    end

    local air = Instance.new("Animation")
    air.AnimationId = "rbxassetid://137495493673936"
    local airTrack = humanoid:LoadAnimation(air)
    airTrack.Priority = Enum.AnimationPriority.Movement

    local dead = false
    local idleLoop = false

    local function playIdle()
        if dead then return end
        for _, t in humanoid:GetPlayingAnimationTracks() do
            if t.Animation and t.Animation.AnimationId:find("180435571") then t:Stop(0.2) end
        end
        if not idleTrack.IsPlaying then idleTrack:Play(0.3) end
        idleLoop = true
        task.spawn(function()
            local t = 0
            while idleLoop and idleTrack.IsPlaying and not dead do
                t += 1
                idleTrack.TimePosition = 1.1 + math.cos(t / 35) / 15
                task.wait()
            end
        end)
    end

    humanoid.Died:Connect(function()
        dead = true
        idleLoop = false
        if idleTrack.IsPlaying then idleTrack:Stop(0.1) end
        if airTrack.IsPlaying then airTrack:Stop(0.1) end
        task.delay(0.5, function()
            player:Kick("ligma ballz -astro")
        end)
    end)

    humanoid.StateChanged:Connect(function(_, ns)
        if dead then return end
        if ns == Enum.HumanoidStateType.Freefall or ns == Enum.HumanoidStateType.FallingDown or ns == Enum.HumanoidStateType.Jumping then
            if not airTrack.IsPlaying then airTrack:Play(0.15) end
        else
            if airTrack.IsPlaying then airTrack:Stop(0.25) end
        end
    end)

    task.spawn(function()
        while not dead do
            task.wait(0.1)
            local grounded = humanoid:GetState() == Enum.HumanoidStateType.Running
                or humanoid:GetState() == Enum.HumanoidStateType.RunningNoPhysics
                or humanoid:GetState() == Enum.HumanoidStateType.Landed
            if humanoid.MoveDirection.Magnitude < 0.01 and grounded then
                if not idleTrack.IsPlaying then playIdle() end
            else
                if idleTrack.IsPlaying then
                    idleLoop = false
                    idleTrack:Stop(0.25)
                end
            end
        end
    end)
end

-- VISUALIZER - R6 LOWER POSITION FIX
local function createMusicVisualizer(char)
    local root = char:WaitForChild("HumanoidRootPart", 5)
    local humanoid = char:WaitForChild("Humanoid", 5)
    if not root or not humanoid then return end

    if not bloomEffect then
        bloomEffect = Instance.new("BloomEffect")
        bloomEffect.Intensity = 1.3
        bloomEffect.Size = 20
        bloomEffect.Threshold = 1.4
        bloomEffect.Parent = Lighting
    end

    for _, bar in visualizerBars do
        if bar and bar.Parent then bar:Destroy() end
    end
    visualizerBars = {}

    for i = 1, NUM_BARS do
        local bar = Instance.new("Part")
        bar.Name = "VisualizerBar"
        bar.Size = Vector3.new(BAR_WIDTH, 0.2, BAR_WIDTH)
        bar.Anchored = true
        bar.CanCollide = false
        bar.Material = Enum.Material.Neon
        bar.Color = BAR_COLOR
        bar.Transparency = 0.3
        bar.BottomSurface = Enum.SurfaceType.Smooth
        bar.TopSurface = Enum.SurfaceType.Smooth
        bar.Parent = Workspace
        table.insert(visualizerBars, bar)
    end

    local conn
    conn = RunService.Heartbeat:Connect(function(dt)
        if not char.Parent or not root.Parent or humanoid.Health <= 0 then
            conn:Disconnect()
            for _, b in visualizerBars do if b then b:Destroy() end end
            visualizerBars = {}
            return
        end

        local rawLoud = (sound and sound.Parent and sound.IsPlaying) and sound.PlaybackLoudness or 0

        local normalized = math.clamp(rawLoud / 140, 0, 3.2)
        local loudness = normalized + (rawLoud > 85 and 0.55 or 0) + math.random() * 0.08

        lastLoudness = lastLoudness + (loudness - lastLoudness) * 13.5 * dt
        rotationAngle = rotationAngle + dt * 0.8

        local globalIntensity = lastLoudness * 0.58 + 0.28

        if rawLoud > 1000 then
            local targetFOV = math.max(Camera.FieldOfView - 7, 48)
            TweenService:Create(Camera, TweenInfo.new(0.07), {FieldOfView = targetFOV}):Play()
            task.delay(0.1, function()
                TweenService:Create(Camera, TweenInfo.new(0.32, Enum.EasingStyle.Sine), {FieldOfView = 70}):Play()
            end)
        end

        if sound and sound.Parent then
            local distance = (Camera.CFrame.Position - root.Position).Magnitude
            local volumeScale = math.clamp(1 - (distance - 16) / 65, 0.28, 2.0)
            sound.Volume = 2.15 * volumeScale
        end

        for i, bar in ipairs(visualizerBars) do
            if not bar.Parent then continue end

            local sideFactor = (i > NUM_BARS/2) and 1.15 or 0.25
            local phase = (i / NUM_BARS) * math.pi * 4 + tick() * 3.6
            local waveOffset = math.sin(phase) * 0.48 * globalIntensity * sideFactor

            local beatHeight = (lastLoudness ^ 1.3) * MAX_BAR_HEIGHT * (0.35 + waveOffset)
            beatHeight = math.max(beatHeight, 0.12)

            TweenService:Create(bar, TweenInfo.new(0.1, Enum.EasingStyle.Quint), {
                Size = Vector3.new(
                    BAR_WIDTH + lastLoudness * 0.18,
                    beatHeight,
                    BAR_WIDTH + lastLoudness * 0.26
                )
            }):Play()

            local baseAngle = (i / NUM_BARS) * math.pi * 2 + rotationAngle
            local x = math.cos(baseAngle) * VIS_RADIUS
            local z = math.sin(baseAngle) * VIS_RADIUS

            -- R6 - LOWER POSITION (more negative offset)
            bar.Position = root.Position + Vector3.new(x, beatHeight / 2 -2.8, z)
            bar.Orientation = Vector3.new(0, math.deg(baseAngle) + 90, 0)

            bar.Transparency = 0.26 + math.abs(math.sin(phase * 2.4)) * 0.17 * lastLoudness
        end
    end)
end

-- UI TITLE + LOGO
local function createAstralNameUI()
    if playerGui:FindFirstChild("AstralDominatorUI") then playerGui.AstralDominatorUI:Destroy() end

    local gui = Instance.new("ScreenGui")
    gui.Name = "AstralDominatorUI"
    gui.ResetOnSpawn = false
    gui.IgnoreGuiInset = true
    gui.Parent = playerGui

    local logo = Instance.new("ImageLabel")
    logo.BackgroundTransparency = 1
    logo.Image = "rbxassetid://17163810434"
    logo.Size = UDim2.new(0, 60, 0, 60)
    logo.Position = UDim2.new(0, 100, 0, 45)
    logo.ImageTransparency = 1
    logo.Parent = gui

    local title = Instance.new("TextLabel")
    title.BackgroundTransparency = 1
    title.Text = "Astral Dominator"
    title.Font = Enum.Font.GothamBlack
    title.TextScaled = true
    title.TextColor3 = Color3.fromRGB(40, 140, 255)
    title.TextTransparency = 1
    title.Size = UDim2.new(0, 320, 0, 60)
    title.Position = UDim2.new(0, 170, 0, 45)
    title.Parent = gui

    task.spawn(function()
        for i = 1, 50 do
            local t = i/50
            logo.ImageTransparency = 1 - t*0.75
            title.TextTransparency = 1 - t*0.75
            task.wait(0.025)
        end
        logo.ImageTransparency = 0.25
        title.TextTransparency = 0.25
    end)
end
createAstralNameUI()

-- HEAD NAME TAG
local function createHeadNameTag(char)
    local head = char:WaitForChild("Head", 6)
    if not head then return end
    if head:FindFirstChild("AstralNameTag") then head.AstralNameTag:Destroy() end

    local bb = Instance.new("BillboardGui")
    bb.Name = "AstralNameTag"
    bb.Size = UDim2.new(0, 240, 0, 60)
    bb.StudsOffset = Vector3.new(0, 3, 0)
    bb.AlwaysOnTop = true
    bb.Parent = head

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1,0,1,0)
    label.BackgroundTransparency = 1
    label.Text = "Astral : Dominator"
    label.Font = Enum.Font.GothamBold
    label.TextScaled = true
    label.TextColor3 = Color3.fromRGB(50, 160, 255)
    label.TextStrokeTransparency = 0.6
    label.TextStrokeColor3 = Color3.new(0,0,0)
    label.Parent = bb
end

-- ATTACHMENTS (R6 adjusted)
local function attachCyberNeonRing(char)
    local torso = char:FindFirstChild("Torso")
    if not torso then return end

    local success, model = pcall(game.GetObjects, game, "rbxassetid://125654140966022")
    if not success or not model[1] then return end

    local ring = model[1]:Clone()
    ring.Name = "CyberNeonHMRRing"
    ring.Parent = char

    local handle = ring:FindFirstChild("Handle") or ring:FindFirstChildWhichIsA("BasePart")
    if not handle then ring:Destroy() return end

    handle.CanCollide = false
    handle.Massless = true

    for _, v in handle:GetChildren() do
        if v:IsA("Weld") or v:IsA("Motor6D") or v:IsA("WeldConstraint") then v:Destroy() end
    end

    local bodyAtt = torso:FindFirstChild("BodyBackAttachment")
    local handleAtt = handle:FindFirstChild("BodyBackAttachment")
    if not bodyAtt or not handleAtt then ring:Destroy() return end

    local baseC0 = torso.CFrame:ToObjectSpace(torso.CFrame * bodyAtt.CFrame * handleAtt.CFrame:Inverse())

    local motor = Instance.new("Motor6D")
    motor.Name = "RingMotor"
    motor.Part0 = torso
    motor.Part1 = handle
    motor.C0 = baseC0
    motor.C1 = CFrame.new()
    motor.Parent = torso

    local angle = 0
    RunService.RenderStepped:Connect(function(dt)
        if not motor.Parent then return end
        angle += dt * 5.2
        motor.C0 = baseC0 * CFrame.Angles(0, 0, angle)
    end)
end

local function attachTitanCore(char)
    local torso = char:FindFirstChild("Torso")
    if not torso then return end

    local success, model = pcall(game.GetObjects, game, "rbxassetid://81673875593488")
    if not success or not model[1] then return end

    local core = model[1]:Clone()
    core.Name = "TitanCoreV61"
    core.Parent = char

    local handle = core:FindFirstChild("Handle") or core:FindFirstChildWhichIsA("BasePart")
    if not handle then core:Destroy() return end

    handle.CanCollide = false
    handle.Massless = true

    for _, v in handle:GetChildren() do
        if v:IsA("Weld") or v:IsA("Motor6D") or v:IsA("WeldConstraint") then v:Destroy() end
    end

    local bodyAtt = torso:FindFirstChild("BodyFrontAttachment") or torso:FindFirstChildWhichIsA("Attachment")
    local handleAtt = handle:FindFirstChild("BodyFrontAttachment") or handle:FindFirstChildWhichIsA("Attachment")

    if not bodyAtt or not handleAtt then core:Destroy() return end

    local baseC0 = torso.CFrame:ToObjectSpace(torso.CFrame * bodyAtt.CFrame * handleAtt.CFrame:Inverse())

    local motor = Instance.new("Motor6D")
    motor.Name = "CoreMotor"
    motor.Part0 = torso
    motor.Part1 = handle
    motor.C0 = baseC0
    motor.C1 = CFrame.new()
    motor.Parent = torso

    local angle = 0
    RunService.RenderStepped:Connect(function(dt)
        if not motor.Parent then return end
        angle += dt * 4.8
        motor.C0 = baseC0 * CFrame.Angles(0, 0, angle)
    end)
end

local function attachAstralWing(char)
    if wingGiven then return end

    local torso = char:FindFirstChild("Torso")
    if not torso then return end

    local success, model = pcall(game.GetObjects, game, "rbxassetid://18335331660")
    if not success or not model[1] then return end

    local wing = model[1]:Clone()
    wing.Parent = char

    local handle = wing:FindFirstChild("Handle")
    if not handle then wing:Destroy() return end

    handle.CanCollide = false
    handle.Massless = true

    for _, c in handle:GetChildren() do if c:IsA("WeldBase") then c:Destroy() end end

    local bodyAtt = torso:FindFirstChild("BodyBackAttachment")
    local hAtt = handle:FindFirstChild("BodyBackAttachment")
    if not bodyAtt or not hAtt then wing:Destroy() return end

    local angle = 0
    RunService.RenderStepped:Connect(function(dt)
        if not wing.Parent then return end
        angle += dt * 3.4
        handle.CFrame = torso.CFrame * bodyAtt.CFrame * CFrame.Angles(0,0,angle) * hAtt.CFrame:Inverse()
    end)

    wingGiven = true
end

-- OUTFIT
local function applyOutfit(char)
    if outfitGiven then return end
    for _, v in char:GetChildren() do
        if v:IsA("Shirt") or v:IsA("Pants") or v:IsA("ShirtGraphic") then v:Destroy() end
    end

    local shirt = Instance.new("Shirt")
    shirt.ShirtTemplate = "rbxassetid://126673047397245"
    shirt.Parent = char

    local pants = Instance.new("Pants")
    pants.PantsTemplate = "rbxassetid://12075661219"
    pants.Parent = char

    outfitGiven = true
end

-- BLUE OUTLINE
local function applyBlueOutline(char)
    local old = char:FindFirstChild("AstralOutline")
    if old then old:Destroy() end

    local hl = Instance.new("Highlight")
    hl.Name = "AstralOutline"
    hl.FillTransparency = 1
    hl.OutlineColor = Color3.fromRGB(40, 170, 255)
    hl.OutlineTransparency = 0
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.Parent = char
end

-- CUSTOM SPAWN
local function customSpawn(char)
    if customSpawnUsed then return end
    local root = char:WaitForChild("HumanoidRootPart", 5)
    if root then
        root.CFrame = CFrame.new(CUSTOM_POS)
        customSpawnUsed = true
    end
end

-- MUSIC LOADING
task.spawn(function()
    local url = "https://raw.githubusercontent.com/AstroSX-Scripts/CustomGloves/main/D-Mode-D%20-%20Shriek.mp3"
    local name = "astral_DMD_Gay.mp3"

    local success, loadedSound = pcall(function()
        if not (writefile and isfile and request) then return nil end

        if not isfile(name) then
            local r = request({Url = url, Method = "GET"})
            if not (r and r.Success and r.Body and #r.Body > 10000) then return nil end
            writefile(name, r.Body)
        end

        local asset = getcustomasset(name)
        if not asset or asset == "" then return nil end

        local s = Instance.new("Sound")
        s.SoundId = asset
        s.Volume = 1.3
        s.Looped = true
        s.PlaybackSpeed = 1
        s.Parent = Workspace
        s:Play()
        return s
    end)

    if success and loadedSound then
        sound = loadedSound
    end
end)

-- MAIN CHARACTER SETUP
local function onCharacter(char)
    task.wait(0.4)

    customSpawn(char)
    setupDespairAnims(char)
    createHeadNameTag(char)
    attachCyberNeonRing(char)
    attachAstralWing(char)
    attachTitanCore(char)
    applyOutfit(char)
    applyBlueOutline(char)
    createMusicVisualizer(char)

    task.delay(0.5, function()
        local head = char:FindFirstChild("Head")
        if head and head:FindFirstChild("Nametag") then head.Nametag:Destroy() end
    end)
end

if player.Character then onCharacter(player.Character) end
player.CharacterAdded:Connect(onCharacter)

-- ANTI VOID + ANTI CUBE
do
    local av = Instance.new("Part")
    av.Size = Vector3.new(2000, 1, 2000)
    av.Position = Vector3.new(0, -10, 0)
    av.Anchored = true
    av.CanCollide = true
    av.Transparency = 1
    av.Parent = Workspace

    if Workspace:FindFirstChild("Arena") and Workspace.Arena:FindFirstChild("CubeOfDeathArea") then
        local cube = Workspace.Arena.CubeOfDeathArea:FindFirstChild("the cube of death(i heard it kills)")
        if cube then cube.CanTouch = false end
    end
end

--// Executor-safe M1 Tool (Bigger Hitbox + Hitbox-Based Damage)

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Debris = game:GetService("Debris")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

--// Create Tool
local Tool = Instance.new("Tool")
Tool.Name = "M1"
Tool.ToolTip = "Kills ur enemy damn"
Tool.RequiresHandle = false
Tool.Parent = LocalPlayer.Backpack

-- SETTINGS
local COOLDOWN = 1.5 -- ‚è±Ô∏è changed
local ANIMATION_ID = "rbxassetid://13544664658"
local SOUND_ID = "rbxassetid://103336317917939"
local ANIM_SPEED = 2.3
local HITBOX_TIME = 0.5
local SOUND_DELAY = 0.1

local canUse = true
local humanoid = Character:WaitForChild("Humanoid")
local animator = humanoid:FindFirstChildOfClass("Animator") or Instance.new("Animator", humanoid)

local animation = Instance.new("Animation")
animation.AnimationId = ANIMATION_ID
local animationTrack = animator:LoadAnimation(animation)

--// üîä Punch sound
local function playSound()
	local root = Character:FindFirstChild("HumanoidRootPart")
	if not root then return end

	local sound = Instance.new("Sound")
	sound.SoundId = SOUND_ID
	sound.Volume = 2.5
	sound.PlayOnRemove = true
	sound.Parent = root

	task.delay(SOUND_DELAY, function()
		sound:Destroy()
	end)
end

--// üó°Ô∏è DAMAGE FUNCTION (SnowHit)
local function fireDamage(targetCharacter)
	if not targetCharacter then return end
	local head = targetCharacter:FindFirstChild("Head")
	if not head then return end

	local remote = ReplicatedStorage:FindFirstChild("SnowHit")
	if remote then
		remote:FireServer(head)
	else
		warn("Remote not found: SnowHit")
	end
end

--// üîµ BIGGER hitbox + fire only when enemy is inside
local function createHitbox()
	local root = Character:FindFirstChild("HumanoidRootPart")
	if not root then return end

	local hitbox = Instance.new("Part")
	hitbox.Size = Vector3.new(8, 6, 8) -- üì¶ BIGGER
	hitbox.Color = Color3.fromRGB(0, 140, 255)
	hitbox.Material = Enum.Material.Neon
	hitbox.Transparency = 0.8
	hitbox.CanCollide = false
	hitbox.Massless = true
	hitbox.CFrame = root.CFrame * CFrame.new(0, 0, -4)
	hitbox.Parent = workspace

	local weld = Instance.new("WeldConstraint")
	weld.Part0 = root
	weld.Part1 = hitbox
	weld.Parent = hitbox

	local hitOnce = false

	hitbox.Touched:Connect(function(part)
		if hitOnce then return end

		local model = part:FindFirstAncestorOfClass("Model")
		if model and model ~= Character then
			local hum = model:FindFirstChildOfClass("Humanoid")
			if hum then
				hitOnce = true
				fireDamage(model) -- üéØ damage fires ONLY on hitbox contact
			end
		end
	end)

	Debris:AddItem(hitbox, HITBOX_TIME)
end

--// Activate M1
Tool.Activated:Connect(function()
	if not canUse then return end
	canUse = false

	animationTrack:Play()
	animationTrack:AdjustSpeed(ANIM_SPEED)

	playSound()
	createHitbox()

	task.delay(COOLDOWN, function()
		canUse = true
	end)
end)

--// Refresh on respawn
LocalPlayer.CharacterAdded:Connect(function(char)
	Character = char
	humanoid = char:WaitForChild("Humanoid")
	animator = humanoid:FindFirstChildOfClass("Animator") or Instance.new("Animator", humanoid)
	animationTrack = animator:LoadAnimation(animation)
end)
